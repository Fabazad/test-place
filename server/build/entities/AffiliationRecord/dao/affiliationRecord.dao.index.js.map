{"version":3,"file":"affiliationRecord.dao.index.js","sources":["entities/AffiliationRecord/dao/affiliationRecord.dao.index.ts"],"sourceRoot":"/","sourcesContent":["import { generateMongooseSchemaFromZod } from \"@/utils/generateMongooseSchemaFromZod/index.js\";\nimport { omittedSavedDataSchema } from \"@/utils/savedDataSchema.js\";\nimport { createSingletonGetter } from \"@/utils/singleton.js\";\nimport mongoose, { Types } from \"mongoose\";\nimport { round } from \"../../../utils/round.js\";\nimport {\n  AffiliatedCommissionStatus,\n  AffiliationRecord,\n  AffiliationRecordParamsType,\n  affiliationRecordSchema,\n  PopulatedAffiliationRecord,\n} from \"../affiliationRecord.entity.js\";\nimport { AffiliationRecordDAO } from \"./affiliationRecord.dao.type.js\";\n\nconst mongooseAffiliationRecordSchema = new mongoose.Schema<AffiliationRecord>(\n  generateMongooseSchemaFromZod(affiliationRecordSchema.omit(omittedSavedDataSchema)),\n  { timestamps: true }\n);\n\nmongooseAffiliationRecordSchema\n  .index({ ambassadorId: 1, \"params.paramsType\": 1, \"params.status\": 1 })\n  .index({ ambassadorId: 1, createdAt: -1 });\n\nconst affiliationRecordModel = mongoose.model<AffiliationRecord>(\n  \"AffiliationRecord\",\n  mongooseAffiliationRecordSchema\n);\n\nconst createAffiliationRecordDAO = (): AffiliationRecordDAO => {\n  return {\n    createAffiliatedCommissionRecord: async ({\n      affiliatedId,\n      ambassadorId,\n      amount,\n      rateInPercent,\n      status,\n    }) => {\n      await affiliationRecordModel.create({\n        params: {\n          paramsType: AffiliationRecordParamsType.AFFILIATED_COMMISSION,\n          affiliated: affiliatedId,\n          rateInPercent,\n          status,\n        },\n        amount,\n        ambassadorId,\n      });\n      return { success: true, data: undefined };\n    },\n    getLastRecords: async ({ page, limit, ambassadorId }) => {\n      const [records, totalCount] = await Promise.all([\n        affiliationRecordModel\n          .find({ ambassadorId })\n          .sort({ createdAt: -1 })\n          .skip((page - 1) * limit)\n          .limit(limit)\n          .populate(\"params.affiliated\")\n          .lean<Array<PopulatedAffiliationRecord>>(),\n        affiliationRecordModel.countDocuments({ ambassadorId }),\n      ]);\n\n      const populatedRecords = records.map<PopulatedAffiliationRecord>((record) => {\n        if (record.params.paramsType === AffiliationRecordParamsType.APP_PAYMENT)\n          return record;\n        return {\n          ...record,\n          params: {\n            ...record.params,\n            affiliated: {\n              _id: record.params.affiliated._id,\n              name: record.params.affiliated.name,\n            },\n          },\n        };\n      });\n\n      return { records: populatedRecords, totalCount };\n    },\n    getTotalGeneratedMoney: async ({ userId }) => {\n      const res = await affiliationRecordModel\n        .aggregate<{ totalGeneratedMoney: number }>([\n          {\n            $match: {\n              ambassadorId: new Types.ObjectId(userId),\n              \"params.paramsType\": AffiliationRecordParamsType.AFFILIATED_COMMISSION,\n              \"params.status\": {\n                $in: [\n                  AffiliatedCommissionStatus.MONEY_RECEIVED,\n                  AffiliatedCommissionStatus.PRODUCT_ORDERED,\n                ],\n              },\n            },\n          },\n          { $group: { _id: null, totalGeneratedMoney: { $sum: \"$amount\" } } },\n        ])\n        .exec();\n\n      return round(res[0]?.totalGeneratedMoney || 0, 2);\n    },\n    getOutstandingBalance: async ({ userId }) => {\n      const res = await affiliationRecordModel\n        .aggregate<{ outstandingBalance: number }>([\n          {\n            $match: {\n              ambassadorId: new Types.ObjectId(userId),\n              $or: [\n                {\n                  \"params.paramsType\": AffiliationRecordParamsType.AFFILIATED_COMMISSION,\n                  \"params.status\": {\n                    $in: [\n                      AffiliatedCommissionStatus.MONEY_RECEIVED,\n                      AffiliatedCommissionStatus.PRODUCT_ORDERED,\n                    ],\n                  },\n                },\n                {\n                  \"params.paramsType\": AffiliationRecordParamsType.APP_PAYMENT,\n                },\n              ],\n            },\n          },\n          { $group: { _id: null, outstandingBalance: { $sum: \"$amount\" } } },\n        ])\n        .exec();\n\n      return round(res[0]?.outstandingBalance || 0, 2);\n    },\n    getRecordsByStatus: async ({ status }) => {\n      const res = await affiliationRecordModel\n        .find({\n          \"params.paramsType\": AffiliationRecordParamsType.AFFILIATED_COMMISSION,\n          \"params.status\": { $in: status },\n        })\n        .lean<Array<AffiliationRecord>>();\n\n      return res;\n    },\n    updateRecords: async (records) => {\n      const bulkWrites = records.map((record) => ({\n        updateOne: {\n          filter: { _id: record._id },\n          update: { $set: record },\n        },\n      }));\n\n      await affiliationRecordModel.bulkWrite(bulkWrites);\n    },\n  };\n};\n\nexport const getAffiliationRecordDAO = createSingletonGetter(createAffiliationRecordDAO);\n"],"names":[],"mappings":"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","debug_id":"6bf7e49c-c39f-5368-8cfe-e065552ecf06"}