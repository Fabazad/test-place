{"version":3,"file":"index.js","sources":["libs/EmailClient/index.ts"],"sourceRoot":"/","sourcesContent":["import { configs } from \"@/configs.js\";\nimport { Role } from \"@/utils/constants.js\";\nimport { createSingletonGetter } from \"@/utils/singleton.js\";\nimport axios from \"axios\";\nimport path from \"path\";\nimport { sendTransactionalEmail } from \"./sendTransactionalEmail.js\";\nimport { TEMPLATE_IDS } from \"./templateIds.js\";\nimport { EmailClient, EmailTemplate } from \"./type.js\";\n\nconst createEmailClient = (): EmailClient => {\n  const brevoAxios = axios.create({\n    baseURL: configs.BREVO_BASE_URL,\n    headers: {\n      \"api-key\": configs.BREVO_API_KEY,\n      accept: \"application/json\",\n      \"content-type\": \"application/json\",\n    },\n  });\n\n  const fromTestPlace = {\n    name: configs.EMAIL_SENDER_NAME,\n    email: configs.EMAIL_SENDER_EMAIL,\n  };\n\n  return {\n    sendContactUsMail: async ({ email, name, language, message }) => {\n      const res = await sendTransactionalEmail({\n        brevoAxios,\n        from: {\n          name,\n          email,\n        },\n        to: {\n          name: configs.EMAIL_SENDER_NAME,\n          email: configs.EMAIL_SENDER_EMAIL,\n        },\n        templateId: TEMPLATE_IDS[EmailTemplate.CONTACT_US][language],\n        templateParams: { name, message },\n      });\n\n      return res;\n    },\n\n    sendEmailValidationMail: async ({\n      email,\n      userId,\n      language,\n      userName,\n      frontendUrl,\n    }) => {\n      const emailValidationLink = path.join(frontendUrl, \"email-validation\", userId);\n\n      const templateId = TEMPLATE_IDS[EmailTemplate.EMAIL_VALIDATION][language];\n\n      console.log({ templateId });\n\n      const res = await sendTransactionalEmail({\n        brevoAxios,\n        from: fromTestPlace,\n        to: {\n          name: userName,\n          email,\n        },\n        templateId,\n        templateParams: { link: emailValidationLink, userName },\n      });\n\n      return res;\n    },\n\n    sendForgottenPasswordMail: async ({\n      email,\n      resetPasswordToken,\n      language,\n      frontendUrl,\n    }) => {\n      const resetPasswordLink = path.join(\n        frontendUrl,\n        \"reset-password\",\n        resetPasswordToken\n      );\n\n      const res = await sendTransactionalEmail({\n        brevoAxios,\n        from: fromTestPlace,\n        to: { email },\n        templateId: TEMPLATE_IDS[EmailTemplate.FORGOTTEN_PASSWORD][language],\n        templateParams: { link: resetPasswordLink },\n      });\n\n      return res;\n    },\n    sendNotificationMail: async ({ notification, to, frontendUrl, userRole }) => {\n      const testLink = path.join(\n        frontendUrl,\n        \"dashboard\",\n        `${\n          userRole === Role.TESTER ? \"my-current-tests\" : \"customer-current-tests\"\n        }?testId=${notification.test._id}`\n      );\n      const res = await sendTransactionalEmail({\n        brevoAxios,\n        from: fromTestPlace,\n        to,\n        templateId: TEMPLATE_IDS[EmailTemplate.NOTIFICATION][to.language],\n        templateParams: {\n          testStatus: notification.test.status,\n          productTitle: notification.product.title,\n          testLink,\n          productImageUrl: notification.product.imageUrls[0],\n        },\n      });\n\n      return res;\n    },\n  };\n};\n\nexport const getEmailClient = createSingletonGetter(createEmailClient);\n\n/*\n  CONTACT_US :\n  templateParams: { name, message }\n\n  EMAIL_VALIDATION :\n  templateParams: { link, userName }\n\n  FORGOTTEN_PASSWORD :\n  templateParams: { link }\n\n  NOTIFICATION :\n  templateParams: { title, message, testLink, productImageUrl }\n*/\n"],"names":[],"mappings":"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","debug_id":"2be85bbb-c5b2-5898-8ef7-62ea94b8f4bc"}