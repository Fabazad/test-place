{"version":3,"file":"index.js","sources":["libs/EmailClient/index.ts"],"sourceRoot":"/","sourcesContent":["import { configs } from \"@/configs.js\";\nimport { NotificationType, Role } from \"@/utils/constants.js\";\nimport { createSingletonGetter } from \"@/utils/singleton.js\";\nimport axios from \"axios\";\nimport { sendTransactionalEmail } from \"./sendTransactionalEmail.js\";\nimport { TEMPLATE_IDS } from \"./templateIds.js\";\nimport { EmailClient, EmailTemplate } from \"./type.js\";\n\nconst createEmailClient = (): EmailClient => {\n  const brevoAxios = axios.create({\n    baseURL: configs.BREVO_BASE_URL,\n    headers: {\n      \"api-key\": configs.BREVO_API_KEY,\n      accept: \"application/json\",\n      \"content-type\": \"application/json\",\n    },\n  });\n\n  const fromTestPlace = {\n    name: configs.EMAIL_SENDER_NAME,\n    email: configs.EMAIL_SENDER_EMAIL,\n  };\n\n  return {\n    sendContactUsMail: async ({ email, name, message }) => {\n      const res = await sendTransactionalEmail({\n        brevoAxios,\n        from: { name, email },\n        to: {\n          name: configs.EMAIL_SENDER_NAME,\n          email: configs.EMAIL_SENDER_EMAIL,\n        },\n        templateId: configs.CONTACT_US_EMAIL_TEMPLATE_ID,\n        templateParams: { name, message },\n      });\n\n      return res;\n    },\n\n    sendEmailValidationMail: async ({\n      email,\n      userId,\n      language,\n      userName,\n      frontendUrl,\n    }) => {\n      const emailValidationLink = new URL(\n        `email-validation/${userId}`,\n        frontendUrl\n      ).toString();\n\n      const templateId = TEMPLATE_IDS[EmailTemplate.EMAIL_VALIDATION][language];\n\n      console.log({ frontendUrl, emailValidationLink });\n\n      const res = await sendTransactionalEmail({\n        brevoAxios,\n        from: fromTestPlace,\n        to: { name: userName, email },\n        templateId,\n        templateParams: { link: emailValidationLink, userName },\n      });\n\n      return res;\n    },\n\n    sendForgottenPasswordMail: async ({\n      email,\n      resetPasswordToken,\n      language,\n      frontendUrl,\n    }) => {\n      const resetPasswordLink = new URL(\n        `reset-password/${resetPasswordToken}`,\n        frontendUrl\n      ).toString();\n\n      const res = await sendTransactionalEmail({\n        brevoAxios,\n        from: fromTestPlace,\n        to: { email },\n        templateId: TEMPLATE_IDS[EmailTemplate.FORGOTTEN_PASSWORD][language],\n        templateParams: { link: resetPasswordLink },\n      });\n\n      return res;\n    },\n\n    sendNotificationMail: async ({ notification, to, frontendUrl, userRole }) => {\n      const testLink = new URL(\n        `dashboard/${\n          userRole === Role.TESTER ? \"my-current-tests\" : \"customer-current-tests\"\n        }?testId=${notification.test._id}`,\n        frontendUrl\n      ).toString();\n\n      const templateMap: { [key in NotificationType]?: EmailTemplate } = {\n        [NotificationType.MONEY_SENT]: EmailTemplate.MONEY_SENT,\n        [NotificationType.NEW_REQUEST]: EmailTemplate.NEW_TEST_REQUEST,\n        [NotificationType.PRODUCT_REVIEWED]: EmailTemplate.PRODUCT_REVIEWED,\n        [NotificationType.REQUEST_ACCEPTED]: EmailTemplate.TEST_REQUEST_ACCEPTED,\n      };\n\n      const defaultTemplate = EmailTemplate.NOTIFICATION;\n\n      const templateId =\n        TEMPLATE_IDS[templateMap[notification.type] || defaultTemplate][to.language];\n\n      const res = await sendTransactionalEmail({\n        brevoAxios,\n        from: fromTestPlace,\n        to,\n        templateId: templateId,\n        templateParams: {\n          testStatus: notification.test.status,\n          productTitle: notification.product.title,\n          testLink,\n          productImageUrl: notification.product.imageUrls[0],\n          name: to.name,\n        },\n      });\n\n      return res;\n    },\n  };\n};\n\nexport const getEmailClient = createSingletonGetter(createEmailClient);\n\n/*\n  CONTACT_US :\n  templateParams: { name, message }\n\n  EMAIL_VALIDATION :\n  templateParams: { link, userName }\n\n  FORGOTTEN_PASSWORD :\n  templateParams: { link }\n\n  NOTIFICATION :\n  templateParams: { title, message, testLink, productImageUrl }\n*/\n"],"names":[],"mappings":"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","debug_id":"132f9832-8286-5aa4-9da8-65df5dc6d396"}