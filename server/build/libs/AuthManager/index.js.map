{"version":3,"file":"index.js","sources":["libs/AuthManager/index.ts"],"sourceRoot":"/","sourcesContent":["import { configs } from \"@/configs.js\";\nimport { Role } from \"@/utils/constants.js\";\nimport { isDecodedUser } from \"@/utils/DecodedUser.type.js\";\nimport { isLanguage, Language } from \"@/utils/Language.js\";\nimport { createSingletonGetter } from \"@/utils/singleton.js\";\nimport axios from \"axios\";\nimport bcrypt from \"bcryptjs\";\nimport { OAuth2Client } from \"google-auth-library\";\nimport jwt from \"jsonwebtoken\";\nimport { AuthManager } from \"./type.js\";\n\nconst createAuthManager = (): AuthManager => {\n  const secret = configs.JWT_KEY;\n  const longSignInDuration = configs.LONG_SIGN_IN_DURATION;\n  const shortSignInDuration = configs.SHORT_SIGN_IN_DURATION;\n  const saltRounds = configs.SALT_ROUNDS;\n\n  const googleClient = new OAuth2Client(configs.SECRET_GOOGLE_CLIENT_ID);\n\n  return {\n    decodeUser: (token) => {\n      const decoded = jwt.verify(token, secret);\n      if (isDecodedUser(decoded)) return decoded;\n      return null;\n    },\n    checkRole: (role, decodedUser) => {\n      return !!(\n        decodedUser &&\n        (decodedUser.roles.includes(role) || decodedUser.roles.includes(Role.ADMIN))\n      );\n    },\n    encodeUser: ({ decodedUser: { userId, roles, amazonId }, staySignedIn }) => {\n      const payload = { userId, roles, amazonId };\n      return jwt.sign(payload, secret, {\n        expiresIn: staySignedIn ? shortSignInDuration : longSignInDuration,\n      });\n    },\n    hashPassword: (password) => {\n      return bcrypt.hashSync(password, saltRounds);\n    },\n    comparePasswords: (password, hashedPassword) => {\n      return bcrypt.compareSync(password, hashedPassword);\n    },\n    generateRandomToken: () => {\n      return Array.from({ length: 16 }, () => {\n        const charCode = Math.floor(Math.random() * 62);\n        if (charCode < 10) {\n          return String.fromCharCode(charCode + 48); // 0-9\n        } else if (charCode < 36) {\n          return String.fromCharCode(charCode + 55); // A-Z\n        } else {\n          return String.fromCharCode(charCode + 61); // a-z\n        }\n      }).join(\"\");\n    },\n    facebookLogin: async ({ accessToken }) => {\n      try {\n        const response = await axios.get<{\n          id: string;\n          name: string;\n          email?: string;\n          first_name: string;\n        }>(\"https://graph.facebook.com/v11.0/me\", {\n          params: {\n            access_token: accessToken,\n            fields: \"id,name,email,first_name\",\n          },\n        });\n\n        const { id, name, email, first_name } = response.data;\n\n        if (!email)\n          return { success: false, errorCode: \"facebook_account_missing_email\" };\n\n        const userName = first_name\n          ? first_name + Math.round(Math.random() * 10000).toString()\n          : name;\n\n        return { success: true, data: { facebookId: id, name: userName, email } };\n      } catch (error: any) {\n        if (axios.isAxiosError(error)) {\n          return {\n            success: false,\n            errorCode: \"unknown_error\",\n            errorMessage: error.message,\n          };\n        }\n        return {\n          success: false,\n          errorCode: \"unknown_error\",\n          errorMessage: error.message,\n        };\n      }\n    },\n    googleLogin: async ({ credential }) => {\n      try {\n        // Verify the token\n        const ticket = await googleClient.verifyIdToken({\n          idToken: credential,\n          audience: configs.PUBLIC_GOOGLE_CLIENT_ID, // Specify the CLIENT_ID of the app that accesses the backend\n        });\n\n        // Get the payload (the user information)\n        const payload = ticket.getPayload();\n\n        if (!payload)\n          return {\n            success: false,\n            errorCode: \"unknown_error\",\n            errorMessage: \"payload is null\",\n          };\n\n        const googleId = payload.sub;\n        const email = payload.email;\n        const name = payload.given_name;\n        const picture = payload.picture;\n        const language =\n          payload.locale && isLanguage(payload.locale) ? payload.locale : Language.FR;\n\n        console.log({ googleId, name, email, language, picture });\n\n        // You can now use this information as needed, for example, store it in your database or create a session\n        return { success: true, data: { googleId, name, email, language } };\n      } catch (error: unknown) {\n        return {\n          success: false,\n          errorCode: \"unknown_error\",\n          errorMessage: error?.toString(),\n        };\n      }\n    },\n  };\n};\n\nexport const getAuthManager = createSingletonGetter(createAuthManager);\n"],"names":[],"mappings":"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","debug_id":"06474d37-5f39-5b76-95d4-1ee94ece9087"}