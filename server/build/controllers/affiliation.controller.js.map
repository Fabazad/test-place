{"version":3,"file":"affiliation.controller.js","sources":["controllers/affiliation.controller.ts"],"sourceRoot":"/","sourcesContent":["import {\n  AffiliatedCommissionStatus,\n  PopulatedAffiliationRecord,\n} from \"@/entities/AffiliationRecord/affiliationRecord.entity.js\";\nimport { getAffiliationRecordDAO } from \"@/entities/AffiliationRecord/dao/affiliationRecord.dao.index.js\";\nimport { TestStatus } from \"@/entities/Test/test.constants.js\";\nimport { getUserDAO } from \"@/entities/User/dao/user.dao.index.js\";\nimport { getMonitoringClient } from \"@/libs/MonitoringClient/index.js\";\nimport { CustomResponse } from \"@/utils/CustomResponse.js\";\n\nexport class AffiliationController {\n  static async getUserAffiliated({\n    userId,\n    page,\n    itemsPerPage,\n    search,\n  }: {\n    userId: string;\n    page: number;\n    itemsPerPage: number;\n    search?: string;\n  }): Promise<\n    CustomResponse<{\n      affiliated: Array<{\n        userId: string;\n        name: string;\n        email: string;\n        rateInPercent: number;\n        createdAt: string;\n      }>;\n      totalCount: number;\n    }>\n  > {\n    const userDAO = getUserDAO();\n    const { affiliated, totalCount } = await userDAO.getUserAffiliated({\n      userId,\n      page,\n      limit: itemsPerPage,\n      search,\n    });\n    return { success: true, data: { affiliated, totalCount } };\n  }\n\n  static async checkForAffiliatedCommissionRecord(params: {\n    affiliatedId: string;\n    productAmount: number;\n    testStatus: TestStatus;\n  }): Promise<CustomResponse<undefined>> {\n    const { affiliatedId, productAmount, testStatus } = params;\n\n    const acceptedTestStatuses = [\n      TestStatus.REQUEST_ACCEPTED,\n      TestStatus.PRODUCT_ORDERED,\n      TestStatus.MONEY_RECEIVED,\n    ];\n    type AcceptedTestStatus = (typeof acceptedTestStatuses)[number];\n\n    const isAcceptedTestStatus = (status: TestStatus): status is AcceptedTestStatus =>\n      (acceptedTestStatuses as Array<TestStatus>).includes(status);\n\n    if (!isAcceptedTestStatus(testStatus)) return { success: true, data: undefined };\n\n    const userDAO = getUserDAO();\n    const affiliationRecordDAO = getAffiliationRecordDAO();\n    const monitoringClient = getMonitoringClient();\n\n    const affiliated = await userDAO.getUser({ userId: affiliatedId });\n    if (!affiliated) {\n      await monitoringClient.sendEvent({\n        level: \"error\",\n        eventName: \"could_not_find_user\",\n        data: { params },\n      });\n      return { success: true, data: undefined };\n    }\n\n    if (!affiliated.affiliated) return { success: true, data: undefined };\n\n    const ambassador = await userDAO.getUser({ userId: affiliated.affiliated.by });\n\n    if (!ambassador) {\n      await monitoringClient.sendEvent({\n        level: \"error\",\n        eventName: \"could_not_find_ambassador\",\n        data: { params, ambassador },\n      });\n      return { success: true, data: undefined };\n    }\n\n    const amount = +parseFloat(\n      `${(productAmount * affiliated.affiliated.rateInPercent) / 100}`\n    ).toFixed(2);\n\n    const testStatusMap: Record<AcceptedTestStatus, AffiliatedCommissionStatus> = {\n      [TestStatus.REQUEST_ACCEPTED]: AffiliatedCommissionStatus.TEST_REQUEST,\n      [TestStatus.MONEY_RECEIVED]: AffiliatedCommissionStatus.MONEY_RECEIVED,\n      [TestStatus.PRODUCT_ORDERED]: AffiliatedCommissionStatus.PRODUCT_ORDERED,\n    };\n\n    await affiliationRecordDAO.createAffiliatedCommissionRecord({\n      affiliatedId,\n      ambassadorId: ambassador._id,\n      rateInPercent: affiliated.affiliated.rateInPercent,\n      amount,\n      status: testStatusMap[testStatus],\n    });\n\n    return { success: true, data: undefined };\n  }\n  static async getLastAffiliationRecords(params: {\n    page: number;\n    itemsPerPage: number;\n    userId: string;\n  }): Promise<\n    CustomResponse<{ records: Array<PopulatedAffiliationRecord>; totalCount: number }>\n  > {\n    const { page, itemsPerPage, userId } = params;\n    const affiliationRecordDAO = getAffiliationRecordDAO();\n\n    const { records, totalCount } = await affiliationRecordDAO.getLastRecords({\n      page,\n      limit: itemsPerPage,\n      ambassadorId: userId,\n    });\n\n    return { success: true, data: { records, totalCount } };\n  }\n\n  static async getUserAffiliationSummary(params: { userId: string }): Promise<\n    CustomResponse<{\n      affiliatedCount: number;\n      totalGeneratedMoney: number;\n      outstandingBalance: number;\n    }>\n  > {\n    const { userId } = params;\n\n    const userDAO = getUserDAO();\n    const affiliationRecordDAO = getAffiliationRecordDAO();\n\n    const [affiliatedCount, totalGeneratedMoney, outstandingBalance] = await Promise.all([\n      userDAO.getUserAffiliatedCount({ userId }),\n      affiliationRecordDAO.getTotalGeneratedMoney({ userId }),\n      affiliationRecordDAO.getOutstandingBalance({ userId }),\n    ]);\n\n    return {\n      success: true,\n      data: { affiliatedCount, totalGeneratedMoney, outstandingBalance },\n    };\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"3ceaf59c-57dd-5053-a991-df52ba5854eb"}